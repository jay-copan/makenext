#!/usr/bin/env bash
set -e

#################################
# Resolve script directory
#################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "$SCRIPT_DIR/scripts/colors"

#################################
# Local dependencies
#################################
DEPS_DIR="$SCRIPT_DIR/deps"
FZF_DIR="$DEPS_DIR/fzf"
FZF_BIN="$FZF_DIR/bin/fzf"

#################################
# Greet
#################################
"$SCRIPT_DIR/scripts/greet"

#################################
# Ensure fzf (local install)
#################################
ensure_fzf() {
  if [[ -x "$FZF_BIN" ]]; then
    return
  fi

  echo -e "${BLUE}‚ûú fzf not found. Installing locally...${RESET}"

  mkdir -p "$DEPS_DIR"

  git clone --depth 1 https://github.com/junegunn/fzf.git "$FZF_DIR"

  # Build binary only (no shell config changes)
  "$FZF_DIR/install" --bin

  if [[ ! -x "$FZF_BIN" ]]; then
    echo -e "${RED}‚ùå Failed to install fzf${RESET}"
    exit 1
  fi
}

#################################
# fzf directory selector
#################################
select_directory() {
  ensure_fzf

  local dir="$HOME"

  while true; do
    choice=$(
      printf "..\n%s\n[ Select this directory ]\n[ Cancel ]" \
        "$(ls -d "$dir"/*/ 2>/dev/null | xargs -n1 basename)" |
      "$FZF_BIN" \
        --prompt="üìÅ $dir > " \
        --height=40% \
        --border \
        --ansi
    )

    case "$choice" in
      "..")
        dir="$(dirname "$dir")"
        ;;
      "[ Select this directory ]")
        SELECTED_DIR="$dir"
        return
        ;;
      "[ Cancel ]" | "")
        echo -e "${RED}Cancelled${RESET}"
        exit 0
        ;;
      *)
        dir="$dir/$choice"
        ;;
    esac
  done
}

#################################
# Info
#################################
echo -e "${LIGHT_BLUE}This script will install:${RESET}"
echo -e "${DIM_BLUE} ‚ñ∏${WHITE} Next.js (default)"
echo -e "${DIM_BLUE} ‚ñ∏${WHITE} shadcn/ui (neutral)"
echo -e "${DIM_BLUE} ‚ñ∏${WHITE} ESLint + Prettier"
echo -e "${DIM_BLUE} ‚ñ∏${WHITE} Commitlint"
echo -e "${DIM_BLUE} ‚ñ∏${WHITE} Husky (pre-commit, post-commit, pre-push)"
echo

read -p "$(echo -e "${BLUE}Continue? (y/n): ${RESET}")" ok
[[ $ok != "y" && $ok != "yes" ]] && echo -e "${RED}Cancelled${RESET}" && exit 0

#################################
# Select install directory
#################################
select_directory
cd "$SELECTED_DIR"

#################################
# Next.js installer (FIXED PATH)
#################################
"$SCRIPT_DIR/installers/install-next"

#################################
# shadcn/ui
#################################
"$SCRIPT_DIR/installers/install-shadcn"

#################################
# ESLint + Prettier
#################################
echo -e "\n${BLUE}‚ûú Setting up ESLint & Prettier${RESET}"
npm install -D prettier eslint-config-prettier eslint-plugin-prettier

cat <<EOF > .prettierrc
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "es5",
  "printWidth": 80
}
EOF

cat <<EOF > .prettierignore
node_modules
.next
dist
EOF

#################################
# Commitlint
#################################
echo -e "\n${BLUE}‚ûú Setting up Commitlint${RESET}"
npm install -D @commitlint/{cli,config-conventional}

cat <<EOF > commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
};
EOF

#################################
# Git + Husky
#################################
echo -e "\n${BLUE}‚ûú Initializing Git${RESET}"
[ ! -d .git ] && git init

echo -e "${BLUE}‚ûú Installing Husky${RESET}"
npm install -D husky
npm pkg set scripts.prepare="husky install"
npx husky install

npm pkg set scripts.format="prettier --write ."
npm pkg set scripts.lint="next lint"

#################################
# Husky hooks
#################################
mkdir -p .husky

cat <<'EOF' > .husky/pre-commit
npm run lint
npm run format
EOF
chmod +x .husky/pre-commit

cat <<EOF > .husky/post-commit
echo "‚úÖ Commit completed successfully"
EOF
chmod +x .husky/post-commit

cat <<EOF > .husky/pre-push
npx commitlint --from=HEAD~1
EOF
chmod +x .husky/pre-push

#################################
# VSCode settings
#################################
mkdir -p .vscode
cat <<'EOF' > .vscode/settings.json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  }
}
EOF

#################################
# Reset page
#################################
mkdir -p app
cat <<'EOF' > app/page.tsx
export default function Home() {
  return (
    <main style={{ padding: '2rem', fontSize: '1.5rem' }}>
      Hello World üëã
    </main>
  );
}
EOF

#################################
# Done
#################################
echo
echo -e "${GREEN}üéâ Setup complete!"
echo -e "${LIGHT_BLUE}Local deps, clean commits, safe pushes üõ°Ô∏è${RESET}"

